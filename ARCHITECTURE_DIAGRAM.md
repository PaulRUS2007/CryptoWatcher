# Диаграмма архитектуры CryptoWatcher

## Общая архитектура системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Пользователь  │    │  Telegram API   │    │  CoinGecko API  │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │                      │                      │
          ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CryptoWatcher Bot                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
│  │   bot.py    │  │ handlers.py │  │ scheduler.py│            │
│  │             │  │             │  │             │            │
│  │ • Инициали- │  │ • Обработка │  │ • Планиров- │            │
│  │   зация     │  │   команд    │  │   щик задач │            │
│  │ • Запуск    │  │ • FSM       │  │ • Фоновые   │            │
│  │   бота      │  │ • Callbacks │  │   задачи    │            │
│  └─────────────┘  └─────────────┘  └─────────────┘            │
│                                                               │
│  ┌─────────────┐  ┌─────────────┐                            │
│  │ database.py │  │coingecko.py │                            │
│  │             │  │             │                            │
│  │ • CRUD      │  │ • HTTP      │                            │
│  │ • SQLite    │  │   запросы   │                            │
│  │ • Миграции  │  │ • Парсинг   │                            │
│  └─────────────┘  └─────────────┘                            │
└─────────────────────────────────────────────────────────────────┘
          │
          ▼
┌─────────────────┐
│   SQLite DB     │
│                 │
│ • users         │
│ • subscriptions │
│ • prices        │
│ • coins         │
│ • coins_list    │
└─────────────────┘
```

## Поток данных

### 1. Регистрация пользователя
```
Пользователь → /start → handlers.py → database.py → SQLite
```

### 2. Добавление подписки
```
Пользователь → "Новая подписка" → handlers.py → coingecko.py → CoinGecko API
                ↓
            database.py → SQLite
```

### 3. Проверка цен (каждые 60 сек)
```
scheduler.py → database.py → SQLite (получение подписок)
     ↓
coingecko.py → CoinGecko API (получение цен)
     ↓
database.py → SQLite (сохранение цен)
     ↓
scheduler.py → анализ изменений → handlers.py → Telegram API
```

## Компоненты системы

### bot.py - Точка входа
```
┌─────────────────┐
│     bot.py      │
├─────────────────┤
│ • Загрузка      │
│   переменных    │
│   окружения     │
├─────────────────┤
│ • Инициализация │
│   Bot и         │
│   Dispatcher    │
├─────────────────┤
│ • Запуск        │
│   планировщика  │
├─────────────────┤
│ • Polling       │
│   обновлений    │
└─────────────────┘
```

### handlers.py - Обработчики команд
```
┌─────────────────┐
│   handlers.py   │
├─────────────────┤
│ • /start        │
│ • "Текущие цены"│
│ • "Мои подписки"│
│ • "Новая        │
│   подписка"     │
├─────────────────┤
│ • Callback      │
│   обработчики   │
├─────────────────┤
│ • FSM состояния │
│   (SubscribeState)│
└─────────────────┘
```

### database.py - Работа с БД
```
┌─────────────────┐
│   database.py   │
├─────────────────┤
│ • init_db()     │
│ • add_user()    │
│ • add_subscription()│
│ • get_prices()  │
├─────────────────┤
│ • CRUD операции │
│   для всех      │
│   таблиц        │
├─────────────────┤
│ • Миграции      │
│   данных        │
└─────────────────┘
```

### scheduler.py - Планировщик
```
┌─────────────────┐
│  scheduler.py   │
├─────────────────┤
│ • check_prices()│
│   (каждые 60с)  │
├─────────────────┤
│ • coins_list_   │
│   worker()      │
│   (каждые 24ч)  │
├─────────────────┤
│ • clear_db()    │
│   (каждый час)  │
└─────────────────┘
```

### coingecko.py - API интеграция
```
┌─────────────────┐
│  coingecko.py   │
├─────────────────┤
│ • fetch_prices()│
│   - GET /simple/│
│     price       │
├─────────────────┤
│ • fetch_coins_  │
│   list()        │
│   - GET /coins/ │
│     list        │
├─────────────────┤
│ • Обработка     │
│   HTTP ошибок   │
└─────────────────┘
```

## Схема базы данных

```
┌─────────────┐    ┌─────────────────┐    ┌─────────────┐
│    users    │    │  subscriptions  │    │    coins    │
├─────────────┤    ├─────────────────┤    ├─────────────┤
│ user_id (PK)│◄───┤ user_id (FK)    │    │ id (PK)     │
└─────────────┘    │ ticker (FK)     │◄───┤ ticker      │
                   │ last_alert      │    └─────────────┘
                   │ alert_threshold │
                   │ interval        │
                   └─────────────────┘
                            │
                            ▼
                   ┌─────────────────┐
                   │     prices      │
                   ├─────────────────┤
                   │ ticker (FK)     │
                   │ price           │
                   │ timestamp       │
                   └─────────────────┘

┌─────────────────┐
│   coins_list    │
├─────────────────┤
│ id (PK)         │
│ ticker          │
│ symbol          │
│ name            │
└─────────────────┘
```

## Временная диаграмма работы системы

```
Время: 0s    60s   120s   180s   3600s   86400s
       │      │      │      │       │       │
       ▼      ▼      ▼      ▼       ▼       ▼
┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐
│Start│ │Check│ │Check│ │Check│ │Clear│ │Update│
│     │ │Price│ │Price│ │Price│ │ DB  │ │Coins│
└─────┘ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘
   │       │       │       │       │       │
   ▼       ▼       ▼       ▼       ▼       ▼
┌─────────────────────────────────────────────────┐
│              Пользовательские команды           │
│  /start, "Текущие цены", "Мои подписки", etc.  │
└─────────────────────────────────────────────────┘
```

## Масштабирование системы

### Горизонтальное масштабирование
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Bot 1     │    │   Bot 2     │    │   Bot N     │
│ (Пользователи│    │ (Пользователи│    │ (Пользователи│
│  1-1000)    │    │ 1001-2000)  │    │  N*1000)   │
└─────────────┘    └─────────────┘    └─────────────┘
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                    ┌─────────────┐
                    │  Shared DB  │
                    │  (PostgreSQL│
                    │   / MySQL)  │
                    └─────────────┘
```

### Вертикальное масштабирование
```
┌─────────────────────────────────────────────────┐
│              Увеличение ресурсов                │
│  • Больше RAM для кэширования                  │
│  • Более быстрый CPU для обработки             │
│  • SSD для быстрого доступа к БД               │
│  • Больше места для хранения истории цен       │
└─────────────────────────────────────────────────┘
```

## Безопасность

### Уровни безопасности
```
┌─────────────────────────────────────────────────┐
│                Безопасность                     │
├─────────────────────────────────────────────────┤
│ 1. Валидация входных данных                     │
│    • Проверка тикеров криптовалют               │
│    • Валидация пользовательского ввода          │
│    • Санитизация SQL запросов                   │
├─────────────────────────────────────────────────┤
│ 2. Ограничение доступа                          │
│    • Проверка прав пользователя                 │
│    • Ограничение частоты запросов               │
│    • Блокировка спама                           │
├─────────────────────────────────────────────────┤
│ 3. Защита данных                                │
│    • Шифрование чувствительных данных           │
│    • Резервное копирование БД                   │
│    • Логирование действий                       │
└─────────────────────────────────────────────────┘
```
